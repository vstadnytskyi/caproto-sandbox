<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Principle of design and operation of CA server &mdash; caproto sandbox 0.0.0.post83+g4c295c1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/clipboard.min.js"></script>
        <script src="_static/copybutton.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example Simple Data Acquisition Unit" href="example_simple_daq.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> caproto sandbox
          </a>
              <div class="version">
                0.0.0.post83+g4c295c1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Principle of design and operation of CA server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#part-1-definition-of-pvs">Part 1: Definition of PVs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#part-2-async-queues">Part 2: Async Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="#part-3-putters-and-getters">Part 3: Putters and Getters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#final-code">Final code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="example_simple_daq.html">Example Simple Data Acquisition Unit</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="min_versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">caproto sandbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Principle of design and operation of CA server</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/usage.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p>Disclaimer:
I am not a developer of the caproto library, I am a user. Here I describe my vision and understanding of the structure of caproto server from a user point of view. I am also hoping to provide some organization solutions.</p>
<section id="principle-of-design-and-operation-of-ca-server">
<h1>Principle of design and operation of CA server<a class="headerlink" href="#principle-of-design-and-operation-of-ca-server" title="Permalink to this headline">¶</a></h1>
<p>In this section I want to break down the typical caproto server code into pieces. Press this link if you want to jump directly to <a class="reference external" href="#final-code">the final code</a></p>
<p>The caproto server consists of three main parts:</p>
<ul class="simple">
<li><p><a class="reference external" href="#part-1-definition-of-pvs">part 1:</a> definition of Process Variables (PVs)</p></li>
<li><p>Initialization of async put and get queues</p></li>
<li><p>Definition of Putter and Getter functions</p></li>
</ul>
<section id="part-1-definition-of-pvs">
<h2>Part 1: Definition of PVs<a class="headerlink" href="#part-1-definition-of-pvs" title="Permalink to this headline">¶</a></h2>
<p>PVs can be conveniently defined at the very beginning of the class definition.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">PVGroup</span><span class="p">):</span>
  <span class="n">running</span> <span class="o">=</span> <span class="n">pvproperty</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">rbv</span> <span class="o">=</span> <span class="n">pvproperty</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
  <span class="n">val</span> <span class="o">=</span> <span class="n">pvproperty</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
</pre></div>
</div>
<p>this simple code will create two PVs with some initial values. The rbv (read-back value) and val (set value) resemble standard names for a typical motor record. In my code, I have added an extra PV ‘running’ the purpose of which will be discussed later.</p>
</section>
<section id="part-2-async-queues">
<h2>Part 2: Async Queues<a class="headerlink" href="#part-2-async-queues" title="Permalink to this headline">¶</a></h2>
<p>Next we need to define asynchronous (async) queue that are used to safely pass calls between asynchronous caproto server and other objects that can be traditional threads. The ‘async def running():’ defines an async function. The decorator &#64;running.startup marks this function as the one that will be executed upon startup of the ‘running’ PV. Inside of this function we will create asynchronous put and get queues.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@running</span><span class="o">.</span><span class="n">startup</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">async_lib</span><span class="p">):</span>
    <span class="s1">&#39;Periodically update the value&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">put_queue</span> <span class="o">=</span> <span class="n">async_lib</span><span class="o">.</span><span class="n">ThreadsafeQueue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">get_queue</span> <span class="o">=</span> <span class="n">async_lib</span><span class="o">.</span><span class="n">ThreadsafeQueue</span><span class="p">()</span>
</pre></div>
</div>
<p>The important part of the caproto server design is the following while loop. This loop is defined in the &#64;running.startup function</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_queue</span><span class="o">.</span><span class="n">async_get</span><span class="p">()</span>
</pre></div>
</div>
<p>This line will asynchronously wait for a new entry in the put_queue.</p>
</section>
<section id="part-3-putters-and-getters">
<h2>Part 3: Putters and Getters<a class="headerlink" href="#part-3-putters-and-getters" title="Permalink to this headline">¶</a></h2>
<p>The rest of the code defines what function will be executed when put(write) and get(read) into a specified PV. The decorator <a class="reference external" href="mailto:'&#37;&#52;&#48;val&#46;putter">‘<span>&#64;</span>val<span>&#46;</span>putter</a>’ shows that the following function will be executed when a ‘put’ or ‘write’ request arrives for the ‘val’ PV.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@val</span><span class="o">.</span><span class="n">putter</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</pre></div>
</div>
<p>The decorator <a class="reference external" href="mailto:'&#37;&#52;&#48;val&#46;getter">‘<span>&#64;</span>val<span>&#46;</span>getter</a>’ indicates that the following function will be executed when a ‘get’ or ‘read’ request arrives for the ‘val’ PV.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@val</span><span class="o">.</span><span class="n">getter</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</pre></div>
</div>
</section>
<section id="final-code">
<h2>Final code<a class="headerlink" href="#final-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="kn">from</span> <span class="nn">caproto.server</span> <span class="kn">import</span> <span class="n">pvproperty</span><span class="p">,</span> <span class="n">PVGroup</span>

<span class="k">class</span> <span class="nc">SimpleIOC</span><span class="p">(</span><span class="n">PVGroup</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An IOC with three uncoupled PVs</span>

<span class="sd">    Scalar PVs</span>
<span class="sd">    ----------</span>
<span class="sd">    running (int)</span>
<span class="sd">    rbv (int)</span>
<span class="sd">    val (int)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">running</span> <span class="o">=</span> <span class="n">pvproperty</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rbv</span> <span class="o">=</span> <span class="n">pvproperty</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">pvproperty</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@running</span><span class="o">.</span><span class="n">startup</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">async_lib</span><span class="p">):</span>
        <span class="s1">&#39;Periodically update the value&#39;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_queue</span> <span class="o">=</span> <span class="n">async_lib</span><span class="o">.</span><span class="n">ThreadsafeQueue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_queue</span> <span class="o">=</span> <span class="n">async_lib</span><span class="o">.</span><span class="n">ThreadsafeQueue</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_queue</span><span class="o">.</span><span class="n">async_get</span><span class="p">()</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pv</span> <span class="o">==</span> <span class="s1">&#39;rbv&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;process a &#39;rbv&#39; put request from a device&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pv</span> <span class="o">==</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;process a &#39;val&#39; put request from a device&quot;</span><span class="p">)</span>

    <span class="nd">@val</span><span class="o">.</span><span class="n">putter</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        called when the a new value is written into &quot;val&quot; PV</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server: &#39;rbv&#39; Got &#39;put&#39; request from outside: new value is </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> and type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;responding to the put request...&#39;</span><span class="p">)</span>

    <span class="nd">@val</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        called when the a new value is readby a client</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Server: &#39;rbv&#39; Got &#39;get&#39; request from outside:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;responding to the get request...&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">caproto.server</span> <span class="kn">import</span> <span class="n">ioc_arg_parser</span><span class="p">,</span> <span class="n">run</span>
    <span class="n">ioc_options</span><span class="p">,</span> <span class="n">run_options</span> <span class="o">=</span> <span class="n">ioc_arg_parser</span><span class="p">(</span>
        <span class="n">default_prefix</span><span class="o">=</span><span class="s1">&#39;simple.&#39;</span><span class="p">,</span>
        <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>
    <span class="n">io</span>  <span class="o">=</span> <span class="n">SimpleIOC</span><span class="p">(</span><span class="o">**</span><span class="n">ioc_options</span><span class="p">)</span>

    <span class="c1">#start async caproto server IO</span>
    <span class="n">run</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">pvdb</span><span class="p">,</span> <span class="o">**</span><span class="n">run_options</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="example_simple_daq.html" class="btn btn-neutral float-right" title="Example Simple Data Acquisition Unit" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019, Valentyn Stadnytskyi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>